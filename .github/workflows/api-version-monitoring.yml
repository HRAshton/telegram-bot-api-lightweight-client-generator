# yaml-language-server: $schema=https://json.schemastore.org/github-workflow

name: Monitor API version
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch: # Allows manual triggering of the workflow
jobs:
  compare-versions:
    runs-on: ubuntu-latest
    outputs:
      api_version: ${{ steps.fetch-api-version.outputs.api_version }}
      package_version: ${{ steps.fetch-version.outputs.package_version }}
    steps:
      - name: Fetch latest NPM package version
        id: fetch-version
        run: |
          # Fetch the latest version of the NPM package via HTTP request
          http_content=$(curl -s https://registry.npmjs.org/telegram-bot-api-lightweight-client/latest)
          version=$(echo $http_content | jq -r '.version')
          echo "package_version=$version" >> "$GITHUB_OUTPUT"

      - name: Fetch latest Telegram Bot API version
        id: fetch-api-version
        run: |
          # Fetch the latest version of the Telegram Bot API via HTTP request
          http_content=$(curl -s https://core.telegram.org/bots/api-changelog)
          version=$(echo $http_content | grep -oP '(?<=Bot API )([\d\.]+)' | head -n 1)
          echo "api_version=$version" >> "$GITHUB_OUTPUT"

  create-issue:
    runs-on: ubuntu-latest
    needs: compare-versions
    if: ${{ ! startsWith(needs.compare-versions.outputs.package_version, needs.compare-versions.outputs.api_version) }}
    steps:
      - uses: actions/checkout@v3

      - name: Create issue
        id: create-issue
        uses: JasonEtco/create-an-issue@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          API_VERSION: ${{ needs.compare-versions.outputs.api_version }}
          PACKAGE_VERSION: ${{ needs.compare-versions.outputs.package_version }}
        with:
          update_existing: true
          search_existing: all
